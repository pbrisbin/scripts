#!/bin/bash
#
# pbrisbin 2009, 2010
#
###

# utities
logger() { echo "$(date +'[ %d %b %Y %H:%M ]') :: $*" | tee -a "$log"; }

errorout() { logger "error: $*"; exit 1; }

message() { echo 'usage: google2mutt'; exit 1; }

backup_current() { cp "$alias" "$alias.bak"; }

get_current() { grep -v '^#\|^$' "$alias"; }

get_google() {
  local IFS='|' email name

  # http://files.pbrisbin.com/gcontacts.py
  #gcontacts.py -m short |\
  $HOME/Code/bin/gcontacts.py -m short |\
  awk -F '\t' '{ if ($1 != "n/a" && $2 != "n/a") print $1 "|" $2 }' |\
  while read -r email name; do
    echo "alias ${name// /_} $name <$email>"
  done
}

write_header() {
  cat > "$swap" << EOF
# vim: ft=muttrc
#
# mutt alias file
#
# autogenerated $(date +'on %d %b at %H:%M') 
#   by $0
#
###
EOF
}

write_entries() {
  local ret=0 tmpfile

  tmpfile="/tmp/file$$"

  get_current >  "$tmpfile" || { ret=1; logger 'could not get current contacts'; }
  get_google  >> "$tmpfile" || { ret=1; logger 'could not get google contacts';  }

  sort "$tmpfile" | uniq >> "$swap" || { ret=1; logger 'could not sort list'; }

  rm "$tmpfile"
  return $ret
}

log="${LOGS:-$PWD}/google2mutt.log"

swap='/tmp/google2mutt.swap'
alias="$HOME/.mutt/alias"

[ "$1" = '-v' ] && verbose=true || verbose=false

$verbose       && logger 'update started'
$verbose       && logger "backing up $alias..."
backup_current || errorout 'unable to backup current file'
$verbose       && logger "writing header to $swap..."
write_header   || errorout 'unable to write header'
$verbose       && logger "writing entries to $swap..."
write_entries  || errorout 'unable to write entries'
$verbose       && logger "moving $swap to $alias..."
mv "$swap" "$alias"

logger 'update complete.'
