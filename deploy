#!/bin/bash
#
# pbrisbin 2010
#
###

message()  { echo 'usage: deploy [--wipe|--post|--help]'; exit 1; }
errorout() { echo "error: $*" >&2; exit 1; }

mv_file() {
  local file="$1"

  if [[ -e "$file" ]]; then
    # todo: rsync or something?
    sudo cp -r "$file" "$prodsite/" || errorout "$file: failed to copy"
  else
    echo "omitting $file; does not exist" >&2
  fi
}

prompt() {
  read -p "$* [Y/n]? " a

  case ${a:-y} in
    Y*|y*) return 0 ;;
    *)     return 1 ;;
  esac
}

devsite="$HOME/Code/haskell/devsite"
prodsite='/srv/http'

wipe=false
post=false

if [[ -n "$1" ]]; then
  case "$1" in
    # options beyond first are ignored
    '--wipe') wipe=true ;;
    '--post') post=true ;;
    '--help') message   ;;
  esac
fi


if pgrep lighttpd &>/dev/null; then
  echo 'stopping services...'
  sudo /etc/rc.d/lighttpd stop || errorout 'failed'
fi

cd "$devsite"

# check variable so we don't rm -rf /
if [[ -n "$prodsite" ]] && $wipe; then
  if prompt "this will WIPE $prodsite/*, are you sure"; then
    echo 'wiping destination...'
    sudo rm -rf "$prodsite/"* || errorout 'failed to wipe destination.'
  fi
fi

echo 'updating static files...'

# --post means we just added a new post, no need to update all the
# static files in the site
if $post; then
  mv_file hamlet
  mv_file cassius
else
  mv_file aur
  mv_file fileshare
  mv_file static
  mv_file xmonad

  mv_file hamlet
  mv_file cassius
fi

touch *.hs
touch */*.hs

echo 'recompiling the application...'
ghc --make -o app.cgi fastcgi.hs || errorout 'failed'

mv_file app.cgi

echo 'fixing permissions...'
sudo chown -R http:http "$prodsite"

echo 'starting services...'
sudo /etc/rc.d/lighttpd start || echo 'failed'

echo 'done.'
