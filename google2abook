#!/bin/bash
#
# pbrisbin 2010
#
###

# utilities
logger() { echo "$(date +'[ %d %b %Y %H %M ]') :: $*" | tee -a "$log"; }

errorout() { logger "error: $*"; exit 1; }

message() { echo "usage: google2abook"; exit 1; }

backup_current() { cp "$addressbook" "$addressbook.bak"; }

write_header() {
  cat > "$swap" << EOF
#
# abook file 
# 
# autogenerated $(date +'on %d %b at %H:%M') 
#   by $0
#
###

[format]
program=abook
version=$(pacman -Q abook | cut -d ' ' -f 2 | cut -d '-' -f 1)

EOF
}

# http://pbrisbin.com/static/fileshare/gcontacts.py
write_entries() { gcontacts.py -m abook >> "$swap"; }

log="${LOGS:-$PWD}/google2abook.log"

swap='/tmp/addressbook.swap'
addressbook="$HOME/.abook/addressbook"

[ "$1" = '-v' ] && verbose=true || verbose=false

$verbose       && logger 'update started'
$verbose       && logger "backing up $addressbook..."
backup_current || errorout 'unable to backup current file'
$verbose       && logger "writing header to $swap..."
write_header   || errorout 'unable to write header'
$verbose       && logger "writing entries to $swap..."
write_entries  || errorout 'unable to write entries'
$verbose       && logger "moving $swap to $addressbook..."
mv "$swap" "$addressbook"

logger 'update complete.'
